{% extends 'navbar.html' %} {% block container %}
<div class="header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
  <h1 class="display-4">Patient Portal</h1>
</div>
<div class="row p-3 justify-content-center">
  <form class="form-inline">
    <div class="form-group">
      <label for="files">Upload Patient Card:</label>
      <div class="pl-3">
        <input type="file" id="files" class="form-control" accept=".csv" required />
      </div>
    </div>
    <div class="pl-3 form-group">
      <button type="submit" class="btn btn-secondary" onclick="removeCard()">Remove Card</button>
    </div>
  </form>
</div>
<div class="container">
  <div class="row">
    <div class="col-6">
      <div class="row">
        <div class="card w-100 mb-2 ml-2 mr-2">
          <div class="card-body">
            <h4 class="card-title">Patient Register</h4>
            <p class="card-text">Register with {{ hospital_name }}.</p>
            <form>
              <div class="form-group">
                <input type="text" class="form-control w-75" id="patient_name" placeholder="Patient Name" />
                <input type="text" class="form-control w-75" id="patient_id" placeholder="Patient ID" />
                <a href="#" class="btn btn-primary" role="button" onclick="register()">Register</a>
              </div>
            </form>
            <div class="card-subtitle mb-2 text-muted">Response:</div>
            <div class="card-text" id="registration-output"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="card w-100 mb-2 ml-2 mr-2">
          <div class="card-body">
            <h4 class="card-title">Patient Read</h4>
            <p class="card-text">Obtain patient medical records.</p>
            <form>
              <div class="form-group">
                <a href="#" class="btn btn-primary" role="button" onclick="read()">Read</a>
              </div>
            </form>
            <div class="card-subtitle mb-2 text-muted">Response:</div>
            <div class="card-text" id="read-output"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6">
      <div class="row">
        <div id="patient_card" class="card w-75 mb-2 ml-2 mr-2" style="height: 200px; overflow-y: scroll;">
          <div class="card-body">
            <h4 class="card-title">Patient Card</h4>
            <div class="card-subtitle mb-2 text-muted">Patient UID: <span class="card-text" id="patient_card_uid"></span></div>
            <div class="card-subtitle mb-2 text-muted">Hospital Name: <span class="card-text"> {{ hospital_name }} </span></div>
            <div class="card-subtitle mb-2 text-muted">Private Key: <span class="card-text" id="patient_card_private_key"></span></div>
          </div>
        </div>
      </div>
    </div>    
  </div>
</div>

<script>
  /*
   * Register takes a patient name and id and also generates a
   * private/public key pair. The private key is kept on the
   * client side and the public key is sent in the request to
   * the server.
   *
   * If registration is successful, the patient's UID along with their
   * public key would have been stored in the hospital's consistent storage
   * service.
   *
   * A patient card is generated client side which
   * stores the private key.
   */
  function register() {
    patient_name_div = $('#patient_name');
    let patient_name = patient_name_div.val();

    patient_id_div = $('#patient_id');
    let patient_id = patient_id_div.val();

    // In the process of storing patient card info.
    var patient_data = [['', '']];

    // Generate the priv/pub key pair.
    crypto.subtle
      .generateKey(
        {
          name: 'RSA-OAEP',
          modulusLength: 2048, // can be 1024, 2048 or 4096
          publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
          hash: { name: 'SHA-256' }, // or SHA-512
        },
        true,
        ['encrypt', 'decrypt']
      )
      .then(function (keyPair) {
        // Private Key Extraction.
        crypto.subtle
          .exportKey('pkcs8', keyPair.privateKey)
          .then(function (exportedPrivateKey) {
            // Converting exported private key to PEM format
            var pem = toPrivPem(exportedPrivateKey);
            patient_data[0][1] = pem;
          })
          .catch(function (err) {
            console.log(err);
          });

        // Public Key Extraction.
        crypto.subtle
          .exportKey('spki', keyPair.publicKey)
          .then(function (exportedPublicKey) {
            // Converting exported public key to PEM format
            var pem = toPubPem(exportedPublicKey);

            // Sending the patient registration request.
            data = { name: patient_name, id: patient_id, pub_key: pem };
            $.ajax({
              url: 'http://localhost:{{api_gateway_port}}/patient_reg',
              type: 'POST',
              dataType: 'json',
              data: JSON.stringify(data),
              error: function (request, status, error) {
                let reg_div = document.getElementById('registration-output');
                reg_div.innerHTML = 'Registration Unsuccessful.';
              },
              success: function (response) {
                let reg_div = document.getElementById('registration-output');
                reg_div.innerHTML = 'Registration Successful.';
                // Download patient card.
                patient_data[0][0] = response.uid;
                download(patient_data);
              },
            });
          })
          .catch(function (err) {
            console.log(err);
          });
      });

    patient_name_div.val('');
    patient_id_div.val('');
  }

  /*
   * If the patient has a card, the uid is sent in the request. 
   * The patient can then decrypt their encrypted medical records 
   * client side.
   */
  function read() {
    let read_output_div = document.getElementById('read-output');
    // Grap the uid from the card.
    card_patient_uid_div = $('#patient_card_uid');
    let patient_uid = card_patient_uid_div.text();
    if (patient_uid == "") {
      read_output_div.innerHTML = 'Please upload your patient card.';
      return
    }
    data = { uid: patient_uid };

    // Make the request.
    $.ajax({
      url: 'http://localhost:{{api_gateway_port}}/patient_read',
      type: 'POST',
      dataType: 'json',
      data: JSON.stringify(data),
      error: function (request, status, error) {
        read_output_div.innerHTML = 'Read Unsuccessful.';
      },
      success: function (response) {
        for (let i = 0; i < response.data.length; i++) {
          // TODO: change this to append divs.
          read_output_div.innerHTML = decrypt(response.data[i]);
        }
      },
    });
  }

  function removeCard() {
    var fileInput = document.getElementById("files");
    fileInput.value = "";

    let card_patient_uid_div = document.getElementById('patient_card_uid');
    card_patient_uid_div.innerHTML = "";

    let card_private_key_div = document.getElementById('patient_card_private_key');
    card_private_key_div.innerHTML = "";

    let read_output_div = document.getElementById('read-output');
    read_output_div.innerHTML = "";
  }

  /* Upload/Download Helper Function */
 
  var fileInput = document.getElementById("files"),

  readFile = function () {
      var reader = new FileReader();
      var uid = "";
      var result = "";
      reader.onload = function () {
          result = reader.result.split(",");
          uid = reader.result.split(",")[1].split("\n")[1];

          let card_patient_uid_div = document.getElementById('patient_card_uid');
          card_patient_uid_div.innerHTML = uid;

          let card_private_key_div = document.getElementById('patient_card_private_key');
          card_private_key_div.innerHTML = result[2];
      };
      // Read the file.
      reader.readAsBinaryString(fileInput.files[0]);
  };

  fileInput.addEventListener('change', readFile);

  function download(data) {
    var csv = 'UID,PRIV_KEY\n';
    data.forEach(function(row) {
            csv += row.join(',');
            csv += "\n";
    });
    var hiddenElement = document.createElement('a');
    hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
    hiddenElement.target = '_blank';
    hiddenElement.download = 'patient_card.csv';
    hiddenElement.click();
  }

  /* Crypto Helper Functions */
  function arrayBufferToBase64(arrayBuffer) {
    var byteArray = new Uint8Array(arrayBuffer);
    var byteString = '';
    for (var i = 0; i < byteArray.byteLength; i++) {
      byteString += String.fromCharCode(byteArray[i]);
    }
    var b64 = window.btoa(byteString);
    return b64;
  }

  function addNewLines(str) {
    var finalString = '';
    while (str.length > 0) {
      finalString += str.substring(0, 64) + '\n';
      str = str.substring(64);
    }
    return finalString;
  }

  function toPubPem(publicKey) {
    var b64 = addNewLines(arrayBufferToBase64(publicKey));
    var pem = '-----BEGIN PUBLIC KEY-----\n' + b64 + '-----END PUBLIC KEY-----';
    return pem;
  }

  function toPrivPem(privateKey) {
    var b64 = addNewLines(arrayBufferToBase64(privateKey));
    var pem = '-----BEGIN PRIVATE KEY-----\n' + b64 + '-----END PRIVATE KEY-----';
    return pem;
  }

  function decrypt(data) {
    const privateKey = document.getElementById('patient_card_private_key').innerHTML;
    const decrypt = new JSEncrypt();
    decrypt.setPrivateKey(privateKey);
    const plainText = decrypt.decrypt(data) || 'DECRYPTION FAILED';
    return plainText;
  }
</script>
{% endblock %}



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Cluster Troubleshooting &mdash; BigchainDB Server 2.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Architecture of a BigchainDB Node Running in a Kubernetes Cluster" href="architecture.html" />
    <link rel="prev" title="Walkthrough: Deploy a Kubernetes Cluster on Azure using Tectonic by CoreOS" href="tectonic-azure.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> BigchainDB Server
          

          
          </a>

          
            
            
              <div class="version">
                2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="https://docs.bigchaindb.com/en/latest/index.html">← Back to All BigchainDB Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production-nodes/index.html">Production Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks.html">BigchainDB Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simple-deployment-template/index.html">Simple Deployment Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-and-test/index.html">Develop &amp; Test BigchainDB Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server-reference/index.html">Settings &amp; CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http-client-server-api.html">The HTTP Client-Server API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../events/index.html">The Events API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers-clients/index.html">Drivers &amp; Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-models/index.html">Data Models</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Kubernetes Deployment Template</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="workflow.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="ca-installation.html">How to Set Up a Self-Signed Certificate Authority</a></li>
<li class="toctree-l2"><a class="reference internal" href="server-tls-certificate.html">How to Generate a Server Certificate for MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-tls-certificate.html">How to Generate a Client Certificate for MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="revoke-tls-certificate.html">How to Revoke an SSL/TLS Certificate</a></li>
<li class="toctree-l2"><a class="reference internal" href="template-kubernetes-azure.html">Template: Deploy a Kubernetes Cluster on Azure</a></li>
<li class="toctree-l2"><a class="reference internal" href="node-on-kubernetes.html">Kubernetes Template: Deploy a Single BigchainDB Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="node-config-map-and-secrets.html">How to Configure a BigchainDB Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="log-analytics.html">Log Analytics on Azure</a></li>
<li class="toctree-l2"><a class="reference internal" href="cloud-manager.html">Configure MongoDB Cloud Manager for Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="easy-rsa.html">How to Install &amp; Configure Easy-RSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-on-kubernetes.html">Kubernetes Template: Upgrade all Software in a BigchainDB Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="bigchaindb-network-on-kubernetes.html">Kubernetes Template: Deploying a BigchainDB network</a></li>
<li class="toctree-l2"><a class="reference internal" href="tectonic-azure.html">Walkthrough: Deploy a Kubernetes Cluster on Azure using Tectonic by CoreOS</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Cluster Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mongodb-restarts">1. MongoDB Restarts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bad-gateway-error-on-runscope-tests">2. 502 Bad Gateway Error on Runscope Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-unreachable">3. Service Unreachable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#single-disk-attached-to-multiple-mountpoints-in-a-container">4. Single Disk Attached to Multiple Mountpoints in a Container</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mongodb-monitoring-agent-throws-a-dial-error-while-connecting-to-mongodb">5. MongoDB Monitoring Agent throws a dial error while connecting to MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-persistent-volume-from-existing-azure-disk-storage-resource">6. Create a Persistent Volume from existing Azure disk storage Resource</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture of a BigchainDB Node Running in a Kubernetes Cluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-reference/index.html">Code Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/index.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BigchainDB Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Kubernetes Deployment Template</a> &raquo;</li>
        
      <li>Cluster Troubleshooting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/k8s-deployment-template/troubleshoot.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cluster-troubleshooting">
<span id="id1"></span><h1>Cluster Troubleshooting<a class="headerlink" href="#cluster-troubleshooting" title="Permalink to this headline">¶</a></h1>
<p>This page describes some basic issues we have faced while deploying and
operating the cluster.</p>
<div class="section" id="mongodb-restarts">
<h2>1. MongoDB Restarts<a class="headerlink" href="#mongodb-restarts" title="Permalink to this headline">¶</a></h2>
<p>We define the following in the <code class="docutils literal notranslate"><span class="pre">mongo-ss.yaml</span></code> file:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resources</span><span class="p">:</span>
  <span class="n">limits</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="mi">200</span><span class="n">m</span>
    <span class="n">memory</span><span class="p">:</span> <span class="mi">5</span><span class="n">G</span>
</pre></div>
</div>
<p>When the MongoDB cache occupies a memory greater than 5GB, it is
terminated by the <code class="docutils literal notranslate"><span class="pre">kubelet</span></code>.
This can usually be verified by logging in to the worker node running MongoDB
container and looking at the syslog (the <code class="docutils literal notranslate"><span class="pre">journalctl</span></code> command should usually
work).</p>
<p>This issue is resolved in
<a class="reference external" href="https://github.com/bigchaindb/bigchaindb/pull/1757">PR #1757</a>.</p>
</div>
<div class="section" id="bad-gateway-error-on-runscope-tests">
<h2>2. 502 Bad Gateway Error on Runscope Tests<a class="headerlink" href="#bad-gateway-error-on-runscope-tests" title="Permalink to this headline">¶</a></h2>
<p>It means that NGINX could not find the appropriate backed to forward the
requests to. This typically happens when:</p>
<ol class="arabic simple">
<li>MongoDB goes down (as described above) and BigchainDB, after trying for
<code class="docutils literal notranslate"><span class="pre">BIGCHAINDB_DATABASE_MAXTRIES</span></code> times, gives up. The Kubernetes BigchainDB
Deployment then restarts the BigchainDB pod.</li>
<li>BigchainDB crashes for some reason. We have seen this happen when updating
BigchainDB from one version to the next. This usually means the older
connections to the service gets disconnected; retrying the request one more
time, forwards the connection to the new instance and succeed.</li>
</ol>
</div>
<div class="section" id="service-unreachable">
<h2>3. Service Unreachable<a class="headerlink" href="#service-unreachable" title="Permalink to this headline">¶</a></h2>
<p>Communication between Kubernetes Services and Deployments fail in
v1.6.6 and before due to a trivial key lookup error for non-existent services
in the <code class="docutils literal notranslate"><span class="pre">kubelet</span></code>.
This error can be reproduced by restarting any public facing (that is, services
using the cloud load balancer) Kubernetes services, and watching the
<code class="docutils literal notranslate"><span class="pre">kube-proxy</span></code> failure in its logs.
The solution to this problem is to restart <code class="docutils literal notranslate"><span class="pre">kube-proxy</span></code> on the affected
worker/agent node. Login to the worker node and run:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>docker stop `docker ps | grep k8s_kube-proxy | cut -d&quot; &quot; -f1`

docker logs -f `docker ps | grep k8s_kube-proxy | cut -d&quot; &quot; -f1`
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/kubernetes/kubernetes/issues/48705">This issue</a> is
<a class="reference external" href="https://github.com/kubernetes/kubernetes/commit/41c4e965c353187889f9b86c3e541b775656dc18">fixed in Kubernetes v1.7</a>.</p>
</div>
<div class="section" id="single-disk-attached-to-multiple-mountpoints-in-a-container">
<h2>4. Single Disk Attached to Multiple Mountpoints in a Container<a class="headerlink" href="#single-disk-attached-to-multiple-mountpoints-in-a-container" title="Permalink to this headline">¶</a></h2>
<p>This is currently the issue faced in one of the clusters and being debugged by
the support team at Microsoft.</p>
<p>The issue was first seen on August 29, 2017 on the Test Network and has been
logged in the <a class="reference external" href="https://github.com/Azure/acs-engine/issues/1364">Azure/acs-engine repo on GitHub</a>.</p>
<p>This is apparently fixed in Kubernetes v1.7.2 which include a new disk driver,
but is yet to tested by us.</p>
</div>
<div class="section" id="mongodb-monitoring-agent-throws-a-dial-error-while-connecting-to-mongodb">
<h2>5. MongoDB Monitoring Agent throws a dial error while connecting to MongoDB<a class="headerlink" href="#mongodb-monitoring-agent-throws-a-dial-error-while-connecting-to-mongodb" title="Permalink to this headline">¶</a></h2>
<p>You might see something similar to this in the MongoDB Monitoring Agent logs:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>Failure dialing host without auth. Err: `no reachable servers`
    at monitoring-agent/components/dialing.go:278
    at monitoring-agent/components/dialing.go:116
    at monitoring-agent/components/dialing.go:213
    at src/runtime/asm_amd64.s:2086
</pre></div>
</div>
<p>The first thing to check is if the networking is set up correctly. You can use
the (maybe using the <cite>toolbox</cite> container).</p>
<p>If everything looks fine, it might be a problem with the <code class="docutils literal notranslate"><span class="pre">Preferred</span>
<span class="pre">Hostnames</span></code> setting in MongoDB Cloud Manager. If you do need to change the
regular expression, ensure that it is correct and saved properly (maybe try
refreshing the MongoDB Cloud Manager web page to see if the setting sticks).</p>
<p>Once you update the regular expression, you will need to remove the deployment
and add it again for the Monitoring Agent to discover and connect to the
MongoDB instance correctly.</p>
<p>More information about this configuration is provided in
<a class="reference internal" href="cloud-manager.html"><span class="doc">this document</span></a>.</p>
</div>
<div class="section" id="create-a-persistent-volume-from-existing-azure-disk-storage-resource">
<h2>6. Create a Persistent Volume from existing Azure disk storage Resource<a class="headerlink" href="#create-a-persistent-volume-from-existing-azure-disk-storage-resource" title="Permalink to this headline">¶</a></h2>
<p>When deleting a k8s cluster, all dynamically-created PVs are deleted, along with the
underlying Azure storage disks (so those can’t be used in a new cluster). resources
are also deleted thus cannot be used in a new cluster. This workflow will preserve
the Azure storage disks while deleting the k8s cluster and re-use the same disks on a new
cluster for MongoDB persistent storage without losing any data.</p>
<p>The template to create two PVs for MongoDB Stateful Set (One for MongoDB data store and
the other for MongoDB config store) is located at <code class="docutils literal notranslate"><span class="pre">mongodb/mongo-pv.yaml</span></code>.</p>
<p>You need to configure <code class="docutils literal notranslate"><span class="pre">diskName</span></code> and <code class="docutils literal notranslate"><span class="pre">diskURI</span></code> in <code class="docutils literal notranslate"><span class="pre">mongodb/mongo-pv.yaml</span></code> file. You can get
these values by logging into your Azure portal and going to <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span></code> and click on your
relevant resource group. From the list of resources click on the storage account resource and
click the container (usually named as <code class="docutils literal notranslate"><span class="pre">vhds</span></code>) that contains storage disk blobs that are available
for PVs. Click on the storage disk file that you wish to use for your PV and you will be able to
see <code class="docutils literal notranslate"><span class="pre">NAME</span></code> and <code class="docutils literal notranslate"><span class="pre">URL</span></code> parameters which you can use for <code class="docutils literal notranslate"><span class="pre">diskName</span></code> and <code class="docutils literal notranslate"><span class="pre">diskURI</span></code> values in
your template respectively and run the following command to create PVs:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl --context &lt;context-name&gt; apply -f mongodb/mongo-pv.yaml
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Please make sure the storage disks you are using are not already being used by any
other PVs. To check the existing PVs in your cluster, run the following command
to get PVs and Storage disk file mapping.</p>
<div class="code bash last highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl --context &lt;context-name&gt; get pv --output yaml
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="architecture.html" class="btn btn-neutral float-right" title="Architecture of a BigchainDB Node Running in a Kubernetes Cluster" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tectonic-azure.html" class="btn btn-neutral float-left" title="Walkthrough: Deploy a Kubernetes Cluster on Azure using Tectonic by CoreOS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, BigchainDB Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
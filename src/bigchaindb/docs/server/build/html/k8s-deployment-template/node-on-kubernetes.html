

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Kubernetes Template: Deploy a Single BigchainDB Node &mdash; BigchainDB Server 2.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Configure a BigchainDB Node" href="node-config-map-and-secrets.html" />
    <link rel="prev" title="Template: Deploy a Kubernetes Cluster on Azure" href="template-kubernetes-azure.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> BigchainDB Server
          

          
          </a>

          
            
            
              <div class="version">
                2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference external" href="https://docs.bigchaindb.com/en/latest/index.html">← Back to All BigchainDB Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production-nodes/index.html">Production Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks.html">BigchainDB Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simple-deployment-template/index.html">Simple Deployment Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-and-test/index.html">Develop &amp; Test BigchainDB Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server-reference/index.html">Settings &amp; CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../http-client-server-api.html">The HTTP Client-Server API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../events/index.html">The Events API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers-clients/index.html">Drivers &amp; Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-models/index.html">Data Models</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Kubernetes Deployment Template</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="workflow.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="ca-installation.html">How to Set Up a Self-Signed Certificate Authority</a></li>
<li class="toctree-l2"><a class="reference internal" href="server-tls-certificate.html">How to Generate a Server Certificate for MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-tls-certificate.html">How to Generate a Client Certificate for MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="revoke-tls-certificate.html">How to Revoke an SSL/TLS Certificate</a></li>
<li class="toctree-l2"><a class="reference internal" href="template-kubernetes-azure.html">Template: Deploy a Kubernetes Cluster on Azure</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Kubernetes Template: Deploy a Single BigchainDB Node</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-install-and-configure-kubectl">Step 1: Install and Configure kubectl</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-connect-to-your-kubernetes-cluster-s-web-ui-optional">Step 2: Connect to Your Kubernetes Cluster’s Web UI (Optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-configure-your-bigchaindb-node">Step 3: Configure Your BigchainDB Node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-start-the-nginx-service">Step 4: Start the NGINX Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-5-assign-dns-name-to-the-nginx-public-ip">Step 5: Assign DNS Name to the NGINX Public IP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-6-start-the-mongodb-kubernetes-service">Step 6: Start the MongoDB Kubernetes Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-7-start-the-bigchaindb-kubernetes-service">Step 7: Start the BigchainDB Kubernetes Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-8-optional-start-the-openresty-kubernetes-service">Step 8(Optional): Start the OpenResty Kubernetes Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-9-start-the-nginx-kubernetes-deployment">Step 9: Start the NGINX Kubernetes Deployment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-10-create-kubernetes-storage-classes-for-mongodb">Step 10: Create Kubernetes Storage Classes for MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-11-create-kubernetes-persistent-volume-claims-for-mongodb">Step 11: Create Kubernetes Persistent Volume Claims for MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-12-start-a-kubernetes-statefulset-for-mongodb">Step 12: Start a Kubernetes StatefulSet for MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-13-configure-users-and-access-control-for-mongodb">Step 13: Configure Users and Access Control for MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-14-create-kubernetes-storage-classes-for-bigchaindb">Step 14: Create Kubernetes Storage Classes for BigchainDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-15-create-kubernetes-persistent-volume-claims-for-bigchaindb">Step 15: Create Kubernetes Persistent Volume Claims for BigchainDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-16-start-a-kubernetes-statefulset-for-bigchaindb">Step 16: Start a Kubernetes StatefulSet for BigchainDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-17-optional-start-a-kubernetes-deployment-for-mongodb-monitoring-agent">Step 17(Optional): Start a Kubernetes Deployment for MongoDB Monitoring Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-18-optional-start-a-kubernetes-deployment-for-openresty">Step 18(Optional): Start a Kubernetes Deployment for OpenResty</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-19-optional-configure-the-mongodb-cloud-manager">Step 19(Optional): Configure the MongoDB Cloud Manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-20-optional-only-for-multi-site-deployments-geographically-dispersed">Step 20(Optional): Only for multi site deployments(Geographically dispersed)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-21-verify-the-bigchaindb-node-setup">Step 21: Verify the BigchainDB Node Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#step-21-1-testing-internally">Step 21.1: Testing Internally</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-21-2-testing-externally">Step 21.2: Testing Externally</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="node-config-map-and-secrets.html">How to Configure a BigchainDB Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="log-analytics.html">Log Analytics on Azure</a></li>
<li class="toctree-l2"><a class="reference internal" href="cloud-manager.html">Configure MongoDB Cloud Manager for Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="easy-rsa.html">How to Install &amp; Configure Easy-RSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-on-kubernetes.html">Kubernetes Template: Upgrade all Software in a BigchainDB Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="bigchaindb-network-on-kubernetes.html">Kubernetes Template: Deploying a BigchainDB network</a></li>
<li class="toctree-l2"><a class="reference internal" href="tectonic-azure.html">Walkthrough: Deploy a Kubernetes Cluster on Azure using Tectonic by CoreOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshoot.html">Cluster Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture of a BigchainDB Node Running in a Kubernetes Cluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-reference/index.html">Code Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/index.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BigchainDB Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Kubernetes Deployment Template</a> &raquo;</li>
        
      <li>Kubernetes Template: Deploy a Single BigchainDB Node</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/k8s-deployment-template/node-on-kubernetes.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kubernetes-template-deploy-a-single-bigchaindb-node">
<span id="id1"></span><h1>Kubernetes Template: Deploy a Single BigchainDB Node<a class="headerlink" href="#kubernetes-template-deploy-a-single-bigchaindb-node" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A highly-available Kubernetes cluster requires at least five virtual machines
(three for the master and two for your app’s containers).
Therefore we don’t recommend using Kubernetes to run a BigchainDB node
if that’s the only thing the Kubernetes cluster will be running.
Instead, see our <a class="reference internal" href="../simple-deployment-template/index.html#simple-deployment-template"><span class="std std-ref">Simple Deployment Template</span></a>.
If your organization already <em>has</em> a big Kubernetes cluster running many containers,
and your organization has people who know Kubernetes,
then this Kubernetes deployment template might be helpful.</p>
</div>
<p>This page describes how to deploy a BigchainDB node
using <a class="reference external" href="https://kubernetes.io/">Kubernetes</a>.
It assumes you already have a running Kubernetes cluster.</p>
<p>Below, we refer to many files by their directory and filename,
such as <code class="docutils literal notranslate"><span class="pre">configuration/config-map.yaml</span></code>. Those files are files in the
<a class="reference external" href="https://github.com/bigchaindb/bigchaindb/">bigchaindb/bigchaindb repository on GitHub</a>
in the <code class="docutils literal notranslate"><span class="pre">k8s/</span></code> directory.
Make sure you’re getting those files from the appropriate Git branch on
GitHub, i.e. the branch for the version of BigchainDB that your BigchainDB
cluster is using.</p>
<div class="section" id="step-1-install-and-configure-kubectl">
<h2>Step 1: Install and Configure kubectl<a class="headerlink" href="#step-1-install-and-configure-kubectl" title="Permalink to this headline">¶</a></h2>
<p>kubectl is the Kubernetes CLI.
If you don’t already have it installed,
then see the <a class="reference external" href="https://kubernetes.io/docs/user-guide/prereqs/">Kubernetes docs to install it</a>.</p>
<p>The default location of the kubectl configuration file is <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code>.
If you don’t have that file, then you need to get it.</p>
<p><strong>Azure.</strong> If you deployed your Kubernetes cluster on Azure
using the Azure CLI 2.0 (as per <a class="reference internal" href="template-kubernetes-azure.html"><span class="doc">our template</span></a>),
then you can get the <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code> file using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ az acs kubernetes get-credentials \
--resource-group &lt;name of resource group containing the cluster&gt; \
--name &lt;ACS cluster name&gt;
</pre></div>
</div>
<p>If it asks for a password (to unlock the SSH key)
and you enter the correct password,
but you get an error message,
then try adding <code class="docutils literal notranslate"><span class="pre">--ssh-key-file</span> <span class="pre">~/.ssh/&lt;name&gt;</span></code>
to the above command (i.e. the path to the private key).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>About kubectl contexts.</strong> You might manage several
Kubernetes clusters. To make it easy to switch from one to another,
kubectl has a notion of “contexts,” e.g. the context for cluster 1 or
the context for cluster 2. To find out the current context, do:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl config view
</pre></div>
</div>
<p>and then look for the <code class="docutils literal notranslate"><span class="pre">current-context</span></code> in the output.
The output also lists all clusters, contexts and users.
(You might have only one of each.)
You can switch to a different context using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl config use-context &lt;new-context-name&gt;
</pre></div>
</div>
<p>You can also switch to a different context for just one command
by inserting <code class="docutils literal notranslate"><span class="pre">--context</span> <span class="pre">&lt;context-name&gt;</span></code> into any kubectl command.
For example:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods
</pre></div>
</div>
<p class="last">will get a list of the pods in the Kubernetes cluster associated
with the context named <code class="docutils literal notranslate"><span class="pre">k8s-bdb-test-cluster-0</span></code>.</p>
</div>
</div>
<div class="section" id="step-2-connect-to-your-kubernetes-cluster-s-web-ui-optional">
<h2>Step 2: Connect to Your Kubernetes Cluster’s Web UI (Optional)<a class="headerlink" href="#step-2-connect-to-your-kubernetes-cluster-s-web-ui-optional" title="Permalink to this headline">¶</a></h2>
<p>You can connect to your cluster’s
<a class="reference external" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">Kubernetes Dashboard</a>
(also called the Web UI) using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl proxy -p 8001

or

$ az acs kubernetes browse -g [Resource Group] -n [Container service instance name] --ssh-key-file /path/to/privateKey
</pre></div>
</div>
<p>or, if you prefer to be explicit about the context (explained above):</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl proxy -p 8001
</pre></div>
</div>
<p>The output should be something like <code class="docutils literal notranslate"><span class="pre">Starting</span> <span class="pre">to</span> <span class="pre">serve</span> <span class="pre">on</span> <span class="pre">127.0.0.1:8001</span></code>.
That means you can visit the dashboard in your web browser at
<a class="reference external" href="http://127.0.0.1:8001/ui">http://127.0.0.1:8001/ui</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Known Issue:</strong> If you are having accessing the UI i.e.
accessing <a class="reference external" href="http://127.0.0.1:8001/ui">http://127.0.0.1:8001/ui</a>
in your browser returns a blank page and is redirected to
<a class="reference external" href="http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy">http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy</a>
, you can access the UI by adding a <strong>/</strong> at the end of the redirected URL i.e.
<a class="reference external" href="http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/">http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/</a></p>
</div>
</div>
<div class="section" id="step-3-configure-your-bigchaindb-node">
<h2>Step 3: Configure Your BigchainDB Node<a class="headerlink" href="#step-3-configure-your-bigchaindb-node" title="Permalink to this headline">¶</a></h2>
<p>See the page titled <a class="reference internal" href="node-config-map-and-secrets.html#how-to-configure-a-bigchaindb-node"><span class="std std-ref">How to Configure a BigchainDB Node</span></a>.</p>
</div>
<div class="section" id="step-4-start-the-nginx-service">
<span id="start-the-nginx-service"></span><h2>Step 4: Start the NGINX Service<a class="headerlink" href="#step-4-start-the-nginx-service" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>This will will give us a public IP for the cluster.</li>
<li>Once you complete this step, you might need to wait up to 10 mins for the
public IP to be assigned.</li>
<li>You have the option to use vanilla NGINX without HTTPS support or an
NGINX with HTTPS support.</li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">Start the Kubernetes Service:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f nginx-https/nginx-https-svc.yaml

OR

$ kubectl apply -f nginx-http/nginx-http-svc.yaml
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="step-5-assign-dns-name-to-the-nginx-public-ip">
<span id="assign-dns-name-to-nginx-public-ip"></span><h2>Step 5: Assign DNS Name to the NGINX Public IP<a class="headerlink" href="#step-5-assign-dns-name-to-the-nginx-public-ip" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">This step is required only if you are planning to set up multiple
<a class="reference external" href="https://docs.bigchaindb.com/en/latest/terminology.html">BigchainDB nodes</a> or are using
HTTPS certificates tied to a domain.</p>
</li>
<li><p class="first">The following command can help you find out if the NGINX service started
above has been assigned a public IP or external IP address:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get svc -w
</pre></div>
</div>
</li>
<li><p class="first">Once a public IP is assigned, you can map it to
a DNS name.
We usually assign <code class="docutils literal notranslate"><span class="pre">bdb-test-node-0</span></code>, <code class="docutils literal notranslate"><span class="pre">bdb-test-node-1</span></code> and
so on in our documentation.
Let’s assume that we assign the unique name of <code class="docutils literal notranslate"><span class="pre">bdb-test-node-0</span></code> here.</p>
</li>
</ul>
</div></blockquote>
<p><strong>Set up DNS mapping in Azure.</strong>
Select the current Azure resource group and look for the <code class="docutils literal notranslate"><span class="pre">Public</span> <span class="pre">IP</span></code>
resource. You should see at least 2 entries there - one for the Kubernetes
master and the other for the NGINX instance. You may have to <code class="docutils literal notranslate"><span class="pre">Refresh</span></code> the
Azure web page listing the resources in a resource group for the latest
changes to be reflected.
Select the <code class="docutils literal notranslate"><span class="pre">Public</span> <span class="pre">IP</span></code> resource that is attached to your service (it should
have the Azure DNS prefix name along with a long random string, without the
<code class="docutils literal notranslate"><span class="pre">master-ip</span></code> string), select <code class="docutils literal notranslate"><span class="pre">Configuration</span></code>, add the DNS assigned above
(for example, <code class="docutils literal notranslate"><span class="pre">bdb-test-node-0</span></code>), click <code class="docutils literal notranslate"><span class="pre">Save</span></code>, and wait for the
changes to be applied.</p>
<p>To verify the DNS setting is operational, you can run <code class="docutils literal notranslate"><span class="pre">nslookup</span> <span class="pre">&lt;DNS</span>
<span class="pre">name</span> <span class="pre">added</span> <span class="pre">in</span> <span class="pre">Azure</span> <span class="pre">configuration&gt;</span></code> from your local Linux shell.</p>
<p>This will ensure that when you scale to different geographical zones, other Tendermint
nodes in the network can reach this instance.</p>
</div>
<div class="section" id="step-6-start-the-mongodb-kubernetes-service">
<span id="start-the-mongodb-kubernetes-service"></span><h2>Step 6: Start the MongoDB Kubernetes Service<a class="headerlink" href="#step-6-start-the-mongodb-kubernetes-service" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">Start the Kubernetes Service:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f mongodb/mongo-svc.yaml
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-7-start-the-bigchaindb-kubernetes-service">
<span id="start-the-bigchaindb-kubernetes-service"></span><h2>Step 7: Start the BigchainDB Kubernetes Service<a class="headerlink" href="#step-7-start-the-bigchaindb-kubernetes-service" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">Start the Kubernetes Service:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f bigchaindb/bigchaindb-svc.yaml
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-8-optional-start-the-openresty-kubernetes-service">
<span id="start-the-openresty-kubernetes-service"></span><h2>Step 8(Optional): Start the OpenResty Kubernetes Service<a class="headerlink" href="#step-8-optional-start-the-openresty-kubernetes-service" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">Start the Kubernetes Service:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f nginx-openresty/nginx-openresty-svc.yaml
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-9-start-the-nginx-kubernetes-deployment">
<span id="start-the-nginx-deployment"></span><h2>Step 9: Start the NGINX Kubernetes Deployment<a class="headerlink" href="#step-9-start-the-nginx-kubernetes-deployment" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>NGINX is used as a proxy to the BigchainDB, Tendermint and MongoDB instances in
the node. It proxies HTTP/HTTPS requests on the <code class="docutils literal notranslate"><span class="pre">node-frontend-port</span></code>
to the corresponding OpenResty(if 3scale enabled) or BigchainDB backend, TCP connections
on <code class="docutils literal notranslate"><span class="pre">mongodb-frontend-port</span></code>, <code class="docutils literal notranslate"><span class="pre">tm-p2p-port</span></code> and <code class="docutils literal notranslate"><span class="pre">tm-pub-key-access</span></code>
to MongoDB and Tendermint respectively.</li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">This configuration is located in the file
<code class="docutils literal notranslate"><span class="pre">nginx-https/nginx-https-dep.yaml</span></code> or <code class="docutils literal notranslate"><span class="pre">nginx-http/nginx-http-dep.yaml</span></code>.</p>
</li>
<li><p class="first">Start the Kubernetes Deployment:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f nginx-https/nginx-https-dep.yaml

OR

$ kubectl apaply -f nginx-http/nginx-http-dep.yaml
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="step-10-create-kubernetes-storage-classes-for-mongodb">
<span id="create-kubernetes-storage-class-mdb"></span><h2>Step 10: Create Kubernetes Storage Classes for MongoDB<a class="headerlink" href="#step-10-create-kubernetes-storage-classes-for-mongodb" title="Permalink to this headline">¶</a></h2>
<p>MongoDB needs somewhere to store its data persistently,
outside the container where MongoDB is running.
Our MongoDB Docker container
(based on the official MongoDB Docker container)
exports two volume mounts with correct
permissions from inside the container:</p>
<ul class="simple">
<li>The directory where the MongoDB instance stores its data: <code class="docutils literal notranslate"><span class="pre">/data/db</span></code>.
There’s more explanation in the MongoDB docs about <a class="reference external" href="https://docs.mongodb.com/manual/reference/configuration-options/#storage.dbPath">storage.dbpath</a>.</li>
<li>The directory where the MongoDB instance stores the metadata for a sharded
cluster: <code class="docutils literal notranslate"><span class="pre">/data/configdb/</span></code>.
There’s more explanation in the MongoDB docs about <a class="reference external" href="https://docs.mongodb.com/manual/reference/configuration-options/#sharding.configDB">sharding.configDB</a>.</li>
</ul>
<p>Explaining how Kubernetes handles persistent volumes,
and the associated terminology,
is beyond the scope of this documentation;
see <a class="reference external" href="https://kubernetes.io/docs/user-guide/persistent-volumes">the Kubernetes docs about persistent volumes</a>.</p>
<p>The first thing to do is create the Kubernetes storage classes.</p>
<p><strong>Set up Storage Classes in Azure.</strong>
First, you need an Azure storage account.
If you deployed your Kubernetes cluster on Azure
using the Azure CLI 2.0
(as per <a class="reference internal" href="template-kubernetes-azure.html"><span class="doc">our template</span></a>),
then the <cite>az acs create</cite> command already created a
storage account in the same location and resource group
as your Kubernetes cluster.
Both should have the same “storage account SKU”: <code class="docutils literal notranslate"><span class="pre">Standard_LRS</span></code>.
Standard storage is lower-cost and lower-performance.
It uses hard disk drives (HDD).
LRS means locally-redundant storage: three replicas
in the same data center.
Premium storage is higher-cost and higher-performance.
It uses solid state drives (SSD).</p>
<p>We recommend using Premium storage with our Kubernetes deployment template.
Create a <a class="reference external" href="https://docs.microsoft.com/en-us/azure/storage/common/storage-create-storage-account">storage account</a>
for Premium storage and associate it with your Azure resource group.
For future reference, the command to create a storage account is
<a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/storage/account#create">az storage account create</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please refer to <a class="reference external" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/premium-storage">Azure documentation</a>
for the list of VMs that are supported by Premium Storage.</p>
</div>
<p>The Kubernetes template for configuration of the MongoDB Storage Class is located in the
file <code class="docutils literal notranslate"><span class="pre">mongodb/mongo-sc.yaml</span></code>.</p>
<p>You may have to update the <code class="docutils literal notranslate"><span class="pre">parameters.location</span></code> field in the file to
specify the location you are using in Azure.</p>
<p>If you want to use a custom storage account with the Storage Class, you
can also update <cite>parameters.storageAccount</cite> and provide the Azure storage
account name.</p>
<p>Create the required storage classes using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f mongodb/mongo-sc.yaml
</pre></div>
</div>
<p>You can check if it worked using <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">storageclasses</span></code>.</p>
</div>
<div class="section" id="step-11-create-kubernetes-persistent-volume-claims-for-mongodb">
<span id="create-kubernetes-persistent-volume-claim-mdb"></span><h2>Step 11: Create Kubernetes Persistent Volume Claims for MongoDB<a class="headerlink" href="#step-11-create-kubernetes-persistent-volume-claims-for-mongodb" title="Permalink to this headline">¶</a></h2>
<p>Next, you will create two PersistentVolumeClaim objects <code class="docutils literal notranslate"><span class="pre">mongo-db-claim</span></code> and
<code class="docutils literal notranslate"><span class="pre">mongo-configdb-claim</span></code>.</p>
<p>This configuration is located in the file <code class="docutils literal notranslate"><span class="pre">mongodb/mongo-pvc.yaml</span></code>.</p>
<p>Note how there’s no explicit mention of Azure, AWS or whatever.
<code class="docutils literal notranslate"><span class="pre">ReadWriteOnce</span></code> (RWO) means the volume can be mounted as
read-write by a single Kubernetes node.
(<code class="docutils literal notranslate"><span class="pre">ReadWriteOnce</span></code> is the <em>only</em> access mode supported
by AzureDisk.)
<code class="docutils literal notranslate"><span class="pre">storage:</span> <span class="pre">20Gi</span></code> means the volume has a size of 20
<a class="reference external" href="https://en.wikipedia.org/wiki/Gibibyte">gibibytes</a>.</p>
<p>You may want to update the <code class="docutils literal notranslate"><span class="pre">spec.resources.requests.storage</span></code> field in both
the files to specify a different disk size.</p>
<p>Create the required Persistent Volume Claims using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f mongodb/mongo-pvc.yaml
</pre></div>
</div>
<p>You can check its status using: <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pvc</span> <span class="pre">-w</span></code></p>
<p>Initially, the status of persistent volume claims might be “Pending”
but it should become “Bound” fairly quickly.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The default Reclaim Policy for dynamically created persistent volumes is <code class="docutils literal notranslate"><span class="pre">Delete</span></code>
which means the PV and its associated Azure storage resource will be automatically
deleted on deletion of PVC or PV. In order to prevent this from happening do
the following steps to change default reclaim policy of dyanmically created PVs
from <code class="docutils literal notranslate"><span class="pre">Delete</span></code> to <code class="docutils literal notranslate"><span class="pre">Retain</span></code></p>
<ul class="simple">
<li>Run the following command to list existing PVs</li>
</ul>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pv
</pre></div>
</div>
<ul class="simple">
<li>Run the following command to update a PV’s reclaim policy to &lt;Retain&gt;</li>
</ul>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl patch pv &lt;pv-name&gt; -p &#39;{&quot;spec&quot;:{&quot;persistentVolumeReclaimPolicy&quot;:&quot;Retain&quot;}}&#39;
</pre></div>
</div>
<p class="last">For notes on recreating a private volume form a released Azure disk resource consult
<a class="reference internal" href="troubleshoot.html"><span class="doc">the page about cluster troubleshooting</span></a>.</p>
</div>
</div>
<div class="section" id="step-12-start-a-kubernetes-statefulset-for-mongodb">
<span id="start-kubernetes-stateful-set-mongodb"></span><h2>Step 12: Start a Kubernetes StatefulSet for MongoDB<a class="headerlink" href="#step-12-start-a-kubernetes-statefulset-for-mongodb" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">Create the MongoDB StatefulSet using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f mongodb/mongo-ss.yaml
</pre></div>
</div>
</li>
<li><p class="first">It might take up to 10 minutes for the disks, specified in the Persistent
Volume Claims above, to be created and attached to the pod.
The UI might show that the pod has errored with the message
“timeout expired waiting for volumes to attach/mount”. Use the CLI below
to check the status of the pod in this case, instead of the UI.
This happens due to a bug in Azure ACS.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -w
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-13-configure-users-and-access-control-for-mongodb">
<span id="configure-users-and-access-control-mongodb"></span><h2>Step 13: Configure Users and Access Control for MongoDB<a class="headerlink" href="#step-13-configure-users-and-access-control-for-mongodb" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">In this step, you will create a user on MongoDB with authorization
to create more users and assign roles to it. We will also create
MongoDB client users for BigchainDB and MongoDB Monitoring agent(Optional).</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f mongodb/configure_mdb.sh
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-14-create-kubernetes-storage-classes-for-bigchaindb">
<span id="create-kubernetes-storage-class"></span><h2>Step 14: Create Kubernetes Storage Classes for BigchainDB<a class="headerlink" href="#step-14-create-kubernetes-storage-classes-for-bigchaindb" title="Permalink to this headline">¶</a></h2>
<p>BigchainDB needs somewhere to store Tendermint data persistently, Tendermint uses
LevelDB as the persistent storage layer.</p>
<p>The Kubernetes template for configuration of Storage Class is located in the
file <code class="docutils literal notranslate"><span class="pre">bigchaindb/bigchaindb-sc.yaml</span></code>.</p>
<p>Details about how to create a Azure Storage account and how Kubernetes Storage Class works
are already covered in this document: <a class="reference internal" href="#create-kubernetes-storage-class-mdb"><span class="std std-ref">Step 10: Create Kubernetes Storage Classes for MongoDB</span></a>.</p>
<p>Create the required storage classes using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f bigchaindb/bigchaindb-sc.yaml
</pre></div>
</div>
<p>You can check if it worked using <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">storageclasses</span></code>.</p>
</div>
<div class="section" id="step-15-create-kubernetes-persistent-volume-claims-for-bigchaindb">
<span id="create-kubernetes-persistent-volume-claim"></span><h2>Step 15: Create Kubernetes Persistent Volume Claims for BigchainDB<a class="headerlink" href="#step-15-create-kubernetes-persistent-volume-claims-for-bigchaindb" title="Permalink to this headline">¶</a></h2>
<p>Next, you will create two PersistentVolumeClaim objects <code class="docutils literal notranslate"><span class="pre">tendermint-db-claim</span></code> and
<code class="docutils literal notranslate"><span class="pre">tendermint-config-db-claim</span></code>.</p>
<p>This configuration is located in the file <code class="docutils literal notranslate"><span class="pre">bigchaindb/bigchaindb-pvc.yaml</span></code>.</p>
<p>Details about Kubernetes Persistent Volumes, Persistent Volume Claims
and how they work with Azure are already covered in this
document: <a class="reference internal" href="#create-kubernetes-persistent-volume-claim-mdb"><span class="std std-ref">Step 11: Create Kubernetes Persistent Volume Claims for MongoDB</span></a>.</p>
<p>Create the required Persistent Volume Claims using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f bigchaindb/bigchaindb-pvc.yaml
</pre></div>
</div>
<p>You can check its status using:</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pvc</span> <span class="o">-</span><span class="n">w</span>
</pre></div>
</div>
</div>
<div class="section" id="step-16-start-a-kubernetes-statefulset-for-bigchaindb">
<span id="start-kubernetes-stateful-set-bdb"></span><h2>Step 16: Start a Kubernetes StatefulSet for BigchainDB<a class="headerlink" href="#step-16-start-a-kubernetes-statefulset-for-bigchaindb" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">This configuration is located in the file <code class="docutils literal notranslate"><span class="pre">bigchaindb/bigchaindb-ss.yaml</span></code>.</p>
</li>
<li><p class="first">Set the <code class="docutils literal notranslate"><span class="pre">spec.serviceName</span></code> to the value set in <code class="docutils literal notranslate"><span class="pre">bdb-instance-name</span></code> in
the ConfigMap.
For example, if the value set in the <code class="docutils literal notranslate"><span class="pre">bdb-instance-name</span></code>
is <code class="docutils literal notranslate"><span class="pre">bdb-instance-0</span></code>, set the field to <code class="docutils literal notranslate"><span class="pre">tm-instance-0</span></code>.</p>
</li>
<li><p class="first">Set <code class="docutils literal notranslate"><span class="pre">metadata.name</span></code>, <code class="docutils literal notranslate"><span class="pre">spec.template.metadata.name</span></code> and
<code class="docutils literal notranslate"><span class="pre">spec.template.metadata.labels.app</span></code> to the value set in
<code class="docutils literal notranslate"><span class="pre">bdb-instance-name</span></code> in the ConfigMap, followed by
<code class="docutils literal notranslate"><span class="pre">-ss</span></code>.
For example, if the value set in the
<code class="docutils literal notranslate"><span class="pre">bdb-instance-name</span></code> is <code class="docutils literal notranslate"><span class="pre">bdb-instance-0</span></code>, set the fields to the value
<code class="docutils literal notranslate"><span class="pre">bdb-insance-0-ss</span></code>.</p>
</li>
<li><p class="first">As we gain more experience running Tendermint in testing and production, we
will tweak the <code class="docutils literal notranslate"><span class="pre">resources.limits.cpu</span></code> and <code class="docutils literal notranslate"><span class="pre">resources.limits.memory</span></code>.</p>
</li>
<li><p class="first">Create the BigchainDB StatefulSet using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f bigchaindb/bigchaindb-ss.yaml
</pre></div>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -w
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-17-optional-start-a-kubernetes-deployment-for-mongodb-monitoring-agent">
<span id="start-kubernetes-deployment-for-mdb-mon-agent"></span><h2>Step 17(Optional): Start a Kubernetes Deployment for MongoDB Monitoring Agent<a class="headerlink" href="#step-17-optional-start-a-kubernetes-deployment-for-mongodb-monitoring-agent" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">This configuration is located in the file
<code class="docutils literal notranslate"><span class="pre">mongodb-monitoring-agent/mongo-mon-dep.yaml</span></code>.</p>
</li>
<li><p class="first">Set <code class="docutils literal notranslate"><span class="pre">metadata.name</span></code>, <code class="docutils literal notranslate"><span class="pre">spec.template.metadata.name</span></code> and
<code class="docutils literal notranslate"><span class="pre">spec.template.metadata.labels.app</span></code> to the value set in
<code class="docutils literal notranslate"><span class="pre">mdb-mon-instance-name</span></code> in the ConfigMap, followed by
<code class="docutils literal notranslate"><span class="pre">-dep</span></code>.
For example, if the value set in the
<code class="docutils literal notranslate"><span class="pre">mdb-mon-instance-name</span></code> is <code class="docutils literal notranslate"><span class="pre">mdb-mon-instance-0</span></code>, set the fields to the
value <code class="docutils literal notranslate"><span class="pre">mdb-mon-instance-0-dep</span></code>.</p>
</li>
<li><p class="first">The configuration uses the following values set in the Secret:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">mdb-mon-certs</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ca-auth</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">cloud-manager-credentials</span></code></li>
</ul>
</li>
<li><p class="first">Start the Kubernetes Deployment using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f mongodb-monitoring-agent/mongo-mon-dep.yaml
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-18-optional-start-a-kubernetes-deployment-for-openresty">
<span id="start-kubernetes-deployment-openresty"></span><h2>Step 18(Optional): Start a Kubernetes Deployment for OpenResty<a class="headerlink" href="#step-18-optional-start-a-kubernetes-deployment-for-openresty" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">This configuration is located in the file
<code class="docutils literal notranslate"><span class="pre">nginx-openresty/nginx-openresty-dep.yaml</span></code>.</p>
</li>
<li><p class="first">Set <code class="docutils literal notranslate"><span class="pre">metadata.name</span></code> and <code class="docutils literal notranslate"><span class="pre">spec.template.metadata.labels.app</span></code> to the
value set in <code class="docutils literal notranslate"><span class="pre">openresty-instance-name</span></code> in the ConfigMap, followed by
<code class="docutils literal notranslate"><span class="pre">-dep</span></code>.
For example, if the value set in the
<code class="docutils literal notranslate"><span class="pre">openresty-instance-name</span></code> is <code class="docutils literal notranslate"><span class="pre">openresty-instance-0</span></code>, set the fields to
the value <code class="docutils literal notranslate"><span class="pre">openresty-instance-0-dep</span></code>.</p>
</li>
<li><p class="first">Set the port to be exposed from the pod in the
<code class="docutils literal notranslate"><span class="pre">spec.containers[0].ports</span></code> section. We currently expose the port at
which OpenResty is listening for requests, <code class="docutils literal notranslate"><span class="pre">openresty-backend-port</span></code> in
the above ConfigMap.</p>
</li>
<li><p class="first">The configuration uses the following values set in the Secret:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">threescale-credentials</span></code></li>
</ul>
</li>
<li><p class="first">The configuration uses the following values set in the ConfigMap:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">node-dns-server-ip</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">openresty-backend-port</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ngx-bdb-instance-name</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">bigchaindb-api-port</span></code></li>
</ul>
</li>
<li><p class="first">Create the OpenResty Deployment using:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f nginx-openresty/nginx-openresty-dep.yaml
</pre></div>
</div>
</li>
<li><p class="first">You can check its status using the command <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">deployments</span> <span class="pre">-w</span></code></p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="step-19-optional-configure-the-mongodb-cloud-manager">
<h2>Step 19(Optional): Configure the MongoDB Cloud Manager<a class="headerlink" href="#step-19-optional-configure-the-mongodb-cloud-manager" title="Permalink to this headline">¶</a></h2>
<p>Refer to the
<a class="reference internal" href="cloud-manager.html"><span class="doc">documentation</span></a>
for details on how to configure the MongoDB Cloud Manager to enable
monitoring and backup.</p>
</div>
<div class="section" id="step-20-optional-only-for-multi-site-deployments-geographically-dispersed">
<h2>Step 20(Optional): Only for multi site deployments(Geographically dispersed)<a class="headerlink" href="#step-20-optional-only-for-multi-site-deployments-geographically-dispersed" title="Permalink to this headline">¶</a></h2>
<p>We need to make sure that clusters are able
to talk to each other i.e. specifically the communication between the
Tendermint peers. Set up networking between the clusters using
<a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes Services</a>.</p>
<p>Assuming we have a BigchainDB instance <code class="docutils literal notranslate"><span class="pre">bdb-instance-1</span></code> residing in Azure data center location <code class="docutils literal notranslate"><span class="pre">westeurope</span></code> and we
want to connect to <code class="docutils literal notranslate"><span class="pre">bdb-instance-2</span></code>, <code class="docutils literal notranslate"><span class="pre">bdb-instance-3</span></code>, and <code class="docutils literal notranslate"><span class="pre">bdb-instance-4</span></code> located in Azure data centers
<code class="docutils literal notranslate"><span class="pre">eastus</span></code>, <code class="docutils literal notranslate"><span class="pre">centralus</span></code> and <code class="docutils literal notranslate"><span class="pre">westus</span></code>, respectively. Unless you already have explicitly set up networking for
<code class="docutils literal notranslate"><span class="pre">bdb-instance-1</span></code> to communicate with <code class="docutils literal notranslate"><span class="pre">bdb-instance-2/3/4</span></code> and
vice versa, we will have to add a Kubernetes Service in each cluster to accomplish this goal in order to set up a
Tendermint P2P network.
It is similar to ensuring that there is a <code class="docutils literal notranslate"><span class="pre">CNAME</span></code> record in the DNS
infrastructure to resolve <code class="docutils literal notranslate"><span class="pre">bdb-instance-X</span></code> to the host where it is actually available.
We can do this in Kubernetes using a Kubernetes Service of <code class="docutils literal notranslate"><span class="pre">type</span></code>
<code class="docutils literal notranslate"><span class="pre">ExternalName</span></code>.</p>
<ul class="simple">
<li>This configuration is located in the file <code class="docutils literal notranslate"><span class="pre">bigchaindb/bigchaindb-ext-conn-svc.yaml</span></code>.</li>
<li>Set the name of the <code class="docutils literal notranslate"><span class="pre">metadata.name</span></code> to the host name of the BigchainDB instance you are trying to connect to.
For instance if you are configuring this service on cluster with <code class="docutils literal notranslate"><span class="pre">bdb-instance-1</span></code> then the <code class="docutils literal notranslate"><span class="pre">metadata.name</span></code> will
be <code class="docutils literal notranslate"><span class="pre">bdb-instance-2</span></code> and vice versa.</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">spec.ports.port[0]</span></code> to the <code class="docutils literal notranslate"><span class="pre">tm-p2p-port</span></code> from the ConfigMap for the other cluster.</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">spec.ports.port[1]</span></code> to the <code class="docutils literal notranslate"><span class="pre">tm-rpc-port</span></code> from the ConfigMap for the other cluster.</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">spec.externalName</span></code> to the FQDN mapped to NGINX Public IP of the cluster you are trying to connect to.
For more information about the FQDN please refer to: <a class="reference internal" href="#assign-dns-name-to-nginx-public-ip"><span class="std std-ref">Assign DNS name to NGINX Public
IP</span></a>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This operation needs to be replicated <code class="docutils literal notranslate"><span class="pre">n-1</span></code> times per node for a <code class="docutils literal notranslate"><span class="pre">n</span></code> node cluster, with the respective FQDNs
we need to communicate with.</p>
<p class="last">If you are not the system administrator of the cluster, you have to get in
touch with the system administrator/s of the other <code class="docutils literal notranslate"><span class="pre">n-1</span></code> clusters and
share with them your instance name (<code class="docutils literal notranslate"><span class="pre">tendermint-instance-name</span></code> in the ConfigMap)
and the FQDN of the NGINX instance acting as Gateway(set in: <a class="reference internal" href="#assign-dns-name-to-nginx-public-ip"><span class="std std-ref">Assign DNS name to NGINX
Public IP</span></a>).</p>
</div>
</div>
<div class="section" id="step-21-verify-the-bigchaindb-node-setup">
<span id="verify-and-test-bdb"></span><h2>Step 21: Verify the BigchainDB Node Setup<a class="headerlink" href="#step-21-verify-the-bigchaindb-node-setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-21-1-testing-internally">
<h3>Step 21.1: Testing Internally<a class="headerlink" href="#step-21-1-testing-internally" title="Permalink to this headline">¶</a></h3>
<p>To test the setup of your BigchainDB node, you could use a Docker container
that provides utilities like <code class="docutils literal notranslate"><span class="pre">nslookup</span></code>, <code class="docutils literal notranslate"><span class="pre">curl</span></code> and <code class="docutils literal notranslate"><span class="pre">dig</span></code>.
For example, you could use a container based on our
<a class="reference external" href="https://hub.docker.com/r/bigchaindb/toolbox/">bigchaindb/toolbox</a> image.
(The corresponding
<a class="reference external" href="https://github.com/bigchaindb/bigchaindb/blob/master/k8s/toolbox/Dockerfile">Dockerfile</a>
is in the <code class="docutils literal notranslate"><span class="pre">bigchaindb/bigchaindb</span></code> repository on GitHub.)
You can use it as below to get started immediately:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl   \
   run -it toolbox \
   --image bigchaindb/toolbox \
   --image-pull-policy=Always \
   --restart=Never --rm
</pre></div>
</div>
<p>It will drop you to the shell prompt.</p>
<p>To test the MongoDB instance:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ nslookup mdb-instance-0

$ dig +noall +answer _mdb-port._tcp.mdb-instance-0.default.svc.cluster.local SRV

$ curl -X GET http://mdb-instance-0:27017
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">nslookup</span></code> command should output the configured IP address of the service
(in the cluster).
The <code class="docutils literal notranslate"><span class="pre">dig</span></code> command should return the configured port numbers.
The <code class="docutils literal notranslate"><span class="pre">curl</span></code> command tests the availability of the service.</p>
<p>To test the BigchainDB instance:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ nslookup bdb-instance-0

$ dig +noall +answer _bdb-api-port._tcp.bdb-instance-0.default.svc.cluster.local SRV

$ dig +noall +answer _bdb-ws-port._tcp.bdb-instance-0.default.svc.cluster.local SRV

$ curl -X GET http://bdb-instance-0:9984

$ curl -X GET http://bdb-instance-0:9986/pub_key.json

$ curl -X GET http://bdb-instance-0:26657/abci_info

$ wsc -er ws://bdb-instance-0:9985/api/v1/streams/valid_transactions
</pre></div>
</div>
<p>To test the OpenResty instance:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ nslookup openresty-instance-0

$ dig +noall +answer _openresty-svc-port._tcp.openresty-instance-0.default.svc.cluster.local SRV
</pre></div>
</div>
<p>To verify if OpenResty instance forwards the requests properly, send a <code class="docutils literal notranslate"><span class="pre">POST</span></code>
transaction to OpenResty at post <code class="docutils literal notranslate"><span class="pre">80</span></code> and check the response from the backend
BigchainDB instance.</p>
<p>To test the vanilla NGINX instance:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ nslookup ngx-http-instance-0

$ dig +noall +answer _public-node-port._tcp.ngx-http-instance-0.default.svc.cluster.local SRV

$ dig +noall +answer _public-health-check-port._tcp.ngx-http-instance-0.default.svc.cluster.local SRV

$ wsc -er ws://ngx-http-instance-0/api/v1/streams/valid_transactions

$ curl -X GET http://ngx-http-instance-0:27017
</pre></div>
</div>
<p>The above curl command should result in the response
<code class="docutils literal notranslate"><span class="pre">It</span> <span class="pre">looks</span> <span class="pre">like</span> <span class="pre">you</span> <span class="pre">are</span> <span class="pre">trying</span> <span class="pre">to</span> <span class="pre">access</span> <span class="pre">MongoDB</span> <span class="pre">over</span> <span class="pre">HTTP</span> <span class="pre">on</span> <span class="pre">the</span> <span class="pre">native</span> <span class="pre">driver</span> <span class="pre">port.</span></code></p>
<p>To test the NGINX instance with HTTPS and 3scale integration:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ nslookup ngx-instance-0

$ dig +noall +answer _public-secure-node-port._tcp.ngx-instance-0.default.svc.cluster.local SRV

$ dig +noall +answer _public-mdb-port._tcp.ngx-instance-0.default.svc.cluster.local SRV

$ dig +noall +answer _public-insecure-node-port._tcp.ngx-instance-0.default.svc.cluster.local SRV

$ wsc -er wss://&lt;node-fqdn&gt;/api/v1/streams/valid_transactions

$ curl -X GET http://&lt;node-fqdn&gt;:27017
</pre></div>
</div>
<p>The above curl command should result in the response
<code class="docutils literal notranslate"><span class="pre">It</span> <span class="pre">looks</span> <span class="pre">like</span> <span class="pre">you</span> <span class="pre">are</span> <span class="pre">trying</span> <span class="pre">to</span> <span class="pre">access</span> <span class="pre">MongoDB</span> <span class="pre">over</span> <span class="pre">HTTP</span> <span class="pre">on</span> <span class="pre">the</span> <span class="pre">native</span> <span class="pre">driver</span> <span class="pre">port.</span></code></p>
</div>
<div class="section" id="step-21-2-testing-externally">
<h3>Step 21.2: Testing Externally<a class="headerlink" href="#step-21-2-testing-externally" title="Permalink to this headline">¶</a></h3>
<p>Check the MongoDB monitoring agent on the MongoDB Cloud Manager
portal to verify they are working fine.</p>
<p>If you are using the NGINX with HTTP support, accessing the URL
<code class="docutils literal notranslate"><span class="pre">http://&lt;DNS/IP</span> <span class="pre">of</span> <span class="pre">your</span> <span class="pre">exposed</span> <span class="pre">BigchainDB</span> <span class="pre">service</span> <span class="pre">endpoint&gt;:node-frontend-port</span></code>
on your browser should result in a JSON response that shows the BigchainDB
server version, among other things.
If you are using the NGINX with HTTPS support, use <code class="docutils literal notranslate"><span class="pre">https</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">http</span></code> above.</p>
<p>Use the Python Driver to send some transactions to the BigchainDB node and
verify that your node or cluster works as expected.</p>
<p>Next, you can set up log analytics and monitoring, by following our templates:</p>
<ul class="simple">
<li><a class="reference internal" href="log-analytics.html"><span class="doc">Log Analytics on Azure</span></a>.</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="node-config-map-and-secrets.html" class="btn btn-neutral float-right" title="How to Configure a BigchainDB Node" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="template-kubernetes-azure.html" class="btn btn-neutral float-left" title="Template: Deploy a Kubernetes Cluster on Azure" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, BigchainDB Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>